---
title: "Data_analysis_birds"
output: html_document
---
load required packages
```{r setup, include=FALSE}
library(tidyverse)
library(neonUtilities)
library(lubridate)
library(hms)
pacman::p_load(tidyverse, broom, lubridate, performance, see, qqplotr, gvlma,ggrepel)
```

pull in csv's for bird and temp data
```{r}
path <- "./Bird_data/"

files <- list.files(path=path, pattern="*.csv")

for(file in files){
  perpos <- which(strsplit(file, "")[[1]]==".")
  assign(
    gsub(" ","",substr(file, 1, perpos-1)),
    read_csv(paste(path,file,sep=""), guess_max = 10000))
}

path <- "./temperature_raw/"

files <- list.files(path=path, pattern="*.csv")

for(file in files){
  perpos <- which(strsplit(file, "")[[1]]==".")
  assign(
    gsub(" ","",substr(file, 1, perpos-1)),
    read_csv(paste(path,file,sep=""), guess_max = 500000))
}
```
Filter N/As out of temp data
```{r}
temp <- SAAT_30min %>% 
  filter(!is.na(tempSingleMean))
```

Remove columns not pertinent to our needs
```{r}
temp_sub <- temp %>% 
  mutate(date = as.Date(startDateTime),
         month = month(date),
         year = year(date),
         day = day(date),
         time = as_hms(startDateTime)) %>% 
  select(siteID, year, month, day, date, time, tempSingleMean:tempSingleMaximum, finalQF)

View(temp_sub)
```

Remove data that failed quality test
```{r}
temp_sub <- temp_sub %>% 
  filter(finalQF != 1)
```

Pull daily average temperature from the temp data
```{r}
daily_temp <- temp_sub  %>% 
  group_by(siteID, date) %>% 
  summarize(dailyMean = mean(tempSingleMean)) %>% 
  arrange(siteID, date)

View(daily_temp)
```

Write daily temp csv
```{r}
daily_temp %>% 
  write_csv('./Data_clean/daily_temp.csv')
```

change bird data name
```{r}
bird_raw <- brd_countdata
```
#select the columns we want to keep in our data
```{r}
bird_raw <- bird_raw %>%
  select(siteID, startDate, taxonID, vernacularName, clusterSize, taxonRank) %>%
  mutate(date = as.Date(startDate),
         time = as_hms(startDate))
         
```


#filter species out of taxonRank column
```{r}
bird_species <- bird_raw %>% 
  filter(taxonRank == "species")
```
#group by species
```{r}
bird_species_T <- bird_species %>%
  group_by(siteID, date, taxonID) %>%
tally()
```

#calculating alpha diversity

```{r}
bird_diversity <- bird_species_T %>%
  group_by(siteID, date)%>%
summarize(alpha = n_distinct(taxonID))
```
```{r}
bird_diversity %>%
  write_csv('./Data_clean/bird_diversity.csv')
```

eliminate NAs
```{r}
bird_count <- bird_raw %>% 
  filter(!is.na(clusterSize))
```


Find total bird count
```{r}
Bird_total<-bird_count %>%
  group_by(siteID, date) %>%
  summarize(total_birds = sum(clusterSize))
```

Write bird total csv
```{r}
Bird_total %>%
  write_csv('./Data_clean/bird_total.csv')
```


Pull in clean data
```{r}
path <- "./Data_clean/"

files <- list.files(path=path, pattern="*.csv")

for(file in files){
  perpos <- which(strsplit(file, "")[[1]]==".")
  assign(
    gsub(" ","",substr(file, 1, perpos-1)),
    read_csv(paste(path,file,sep=""), guess_max = 10000))
}

```
Join clean data
```{r}
full_data <- full_join(bird_diversity, bird_total) %>% 
  full_join(., daily_temp) 

View(full_data)
```

Filter out NAs
```{r}
full_data <- full_data %>% 
  filter(!is.na(alpha & dailyMean))
```

summarize data for statistics
```{r}
summary <- full_data %>% 
  group_by(siteID) %>% 
  summarize(n = n(),  # Sample size
            mean_dailyMean = mean(dailyMean), sd_dailyMean = sd(dailyMean), se_dailyMean = sd_dailyMean/sqrt(n), # Mean, sd, se for dailyMean
            mean_alpha = mean(alpha), sd_alpha = sd(alpha), se_alpha = sd_alpha/sqrt(n),
            mean_total = mean(total_birds), sd_total = sd(total_birds), se_total = sd_total/sqrt(n))

glimpse(summary)
```

Round decimals
```{r}
summary <- as_tibble(summary) %>% 
  mutate_at(vars(mean_dailyMean:se_total), funs(round(.,2))) # Round each of our calculated columns to 2 decimals

print(summary)
```

Linear regression
```{r}
ggplot(data = full_data, aes(x = dailyMean, # name the variable that goes on the x-axis
                                    y = alpha,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  theme_minimal()
```

```{r}
ggplot(data = full_data, aes(x = dailyMean, # name the variable that goes on the x-axis
                                    y = total_birds,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  theme_minimal()
```

Run correlation for diversity
```{r}
cor_div <- cor.test(full_data$dailyMean, 
                      full_data$alpha, 
                      method = "pearson") # can also use method = "spearman"

tidy(cor_div)
```

Run linear regression test for diversity
```{r}
div_model <- lm(alpha ~ dailyMean, data = full_data)
```
```{r}
#check_model(div_model)
gvlma(div_model)
```
```{r}
summary(div_model)
```
```{r}
ggplot(data = full_data, aes(x = dailyMean, # name the variable that goes on the x-axis
                                    y = alpha,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  geom_smooth(method = 'lm', aes(group=1), col = 'black', lty = 1) +  # lty=1 for solid line
  #geom_abline(intercept = 6.81098, slope = -0.08871) +  # Alternate method than geom_smooth to specify line slope & intercept
  theme_minimal()
```


Run correlation for total
```{r}
cor_total <- cor.test(full_data$dailyMean, 
                      full_data$total_birds, 
                      method = "pearson") # can also use method = "spearman"

tidy(cor_total)
```

run linear regression for total
```{r}
total_model <- lm(total_birds ~ dailyMean, data = full_data)
```
```{r}
#check_model(model_name2)
gvlma(total_model)
```

```{r}
summary(total_model)
```

## remove outliers then run regression
```{r}
subset<-full_data %>%
  filter(total_birds<300)
```

```{r}
cor_total_subset <- cor.test(subset$dailyMean, 
                      subset$total_birds, 
                      method = "pearson") # can also use method = "spearman"

tidy(cor_total_subset)
```
```{r}
total_model_subset <- lm(total_birds ~ dailyMean, data = subset)
```
```{r}
gvlma(total_model_subset)
```
```{r}
summary(total_model_subset)
```
```{r}
ggplot(data = subset, aes(x = dailyMean, # name the variable that goes on the x-axis
                                    y = total_birds,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  geom_smooth(method = 'lm', aes(group=1), col = 'black', lty = 1) +  # lty=1 for solid line
  #geom_abline(intercept = 6.81098, slope = -0.08871) +  # Alternate method than geom_smooth to specify line slope & intercept
  theme_minimal()
```

